{% extends "portal/base.html" %}

{% block title %}Analysis{% endblock %}

{% block javascript %}
    <script src="/static/portal/jquery-2.0.3.min.js"></script>
	<script src="/static/portal/noxss.js"></script>
    <script src="/static/portal/permissions.js"></script>
    <script src="/static/portal/ajaxsearchfilter.js"></script>
    <script src="/static/pipeline/jsBezier-0.6.js"></script>
    <script src="/static/pipeline/drydock_objects.js"></script>
    <script src="/static/pipeline/drydock.js"></script>
    <script src="/static/pipeline/pipeline_load.js"></script>
    <script type="text/javascript">

    $(function() {
        "use strict";
        noXSS();

        var IS_USER_ADMIN = false; // Never show admin tools on this page
        
        var PipelineFamiliesTable = function($table, is_user_admin, $navigation_links) {
            permissions.PermissionsTable.call(this, $table, is_user_admin, $navigation_links);
            this.list_url = "/api/pipelinefamilies/";

            this.registerColumn("Pipeline Family", "name");
            this.registerColumn("Thumbnail", buildThumbnail);
            this.registerColumn("Revision", buildMembers);
            this.registerStandardColumn("user");
            this.registerStandardColumn("users_allowed");
            this.registerStandardColumn("groups_allowed");
        };
        PipelineFamiliesTable.prototype = Object.create(
                permissions.PermissionsTable.prototype);
        PipelineFamiliesTable.prototype.buildTable = function(rows) {
            permissions.PermissionsTable.prototype.buildTable.call(this, rows);
            this.drawThumbnails();
        };
        PipelineFamiliesTable.prototype.drawThumbnails = function() {
            this.$table.find('select').each(function() { drawThumbnail(this); });
        };
        
        function drawThumbnail(select) {
            var $select = $(select),
                $canvas = $select.closest('tr').find('canvas'),
                canvas = $canvas[0];
            $.ajax({
                type: "GET",
                url: "/api/pipelines/" + $select.val(),
                datatype: "json",
                success: function(result) {
                    var cs = new drydock.CanvasState(canvas);
                    var pipeline = new Pipeline(cs);
                    cs.setScale(0.12);
                    cs.enable_labels = false;
                    pipeline.load(result);
                    pipeline.draw();
                }
            });
        }
        function buildThumbnail($td, row) {
            $td.addClass('preview-canvas');
            $('<canvas class="preview" width="120" height="90">' +
                    'Warning: Kive does not support your web browser.</canvas>')
                    .appendTo($td);
        }
        function buildMembers($td, row) {
            var $form = $('<form method="GET" action="choose_inputs">'),
                $select = $('<select name="pipeline">'),
                already_have_one_selected = false,
                i, member, $option;

            if (row.members.length === 0) {
                $option = $("<option>")
                    .attr("disabled", true)
                    .text("No published versions");
                $select.append($option).appendTo($form);
            } else {
                for (i = 0; i < row.members.length; i++) {
                    member = row.members[i];
                    $option = $('<option>').attr('value', member.id);
                    if (member.published) {
                        $option.text(member.display_name);
                        if (!already_have_one_selected) {
                            $option.attr('selected', true);
                            already_have_one_selected = true;
                        }
                    } else {
                        // De-emphasize this.
                        $option.text("(" + member.display_name + ")");
                    }
                    $select.append($option);
                }
                $select.change(function() { drawThumbnail(this); });
                $form.append($select, '&nbsp;<input type="submit" value="Choose">');
            }
            $td.append($form);
        }

        var table = new PipelineFamiliesTable(
                $('#pipeline_families'),
                IS_USER_ADMIN,
                $(".navigation_links")
        );
        var asf = new AjaxSearchFilter(table);
        asf.reloadTable();
    });

    </script>
{% endblock %}

{% block stylesheets %}
    <link rel="stylesheet" href="/static/sandbox/sandbox.css"/>
    <link rel="stylesheet" href="/static/portal/search.css"/>
    <link rel="stylesheet" href="/static/portal/permissions.css"/>
{% endblock %}

{% block content %}

<a href="usr.html" rel="prev">Back to user portal</a>

<h2>Analysis</h2>

<p>
Please select a pipeline you would like to run on this page.
</p>

<form class="asf-form">
    <div class="asf-main-search">
        <div class="asf-active-filters"></div>
        <input type="text" name="smart" class="asf-search-field">
        <input type="submit" value="Filter" class="asf-search-button">
    </div>
</form>

<div class="navigation_links"></div>

<div class="results2">
    <table id="pipeline_families"></table>
</div>

<div class="errortext">{{ error_msg }}</div>
<div id="errors" class="errortext"></div>

{% endblock %}
