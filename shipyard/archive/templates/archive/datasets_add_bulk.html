<!-- Django template -->
<!-- Display contents of Methods as a HTML table -->

{% extends "portal/base.html" %}

{% block title %}Datasets{% endblock %}
<style>
    .bar {
        height: 18px;
        background: green;
    }

    .bulk_dataset_table {
        overflow:scroll;
        height:50em;
    }

    .loading_container {
        position:absolute;
        top:0;
        left:0;
        width:100%;
        height:100%;
        z-index:1000;
        background-color:grey;
        opacity: .8;
    }

    .loading_img {
        position: absolute;
        left: 50%;
        top: 50%;
        margin-left: -32px; /* -1 * image width / 2 */
        margin-top: -32px;  /* -1 * image height / 2 */
        display: block;
    }

</style>
{% block javascript %}
    <script src="/static/portal/jquery-2.0.3.min.js"></script>
    <script src="/static/portal/jquery-ui-1.10.4.custom.min.js"></script>
    <script>
        // Taken from http://tutorialzine.com/2013/05/mini-ajax-file-upload-form/
        // Helper function that formats the file sizes
        function formatFileSize(bytes) {
            if (typeof bytes !== 'number') {
                return '';
            }

            if (bytes >= 1000000000) {
                return (bytes / 1000000000).toFixed(2) + ' GB';
            }

            if (bytes >= 1000000) {
                return (bytes / 1000000).toFixed(2) + ' MB';
            }

            return (bytes / 1000).toFixed(2) + ' KB';
        }

        $("document").ready(function(e){

            if (window.File && window.FileReader && window.FileList && window.Blob) {
              // Great success! All the File APIs are supported.
            } else {
              alert('Unsupported browser');
            }

            // Hide loading gif
            $("#loading").hide();

            $("#id_dataset_files").change(function() {
                // clear contents of Upload Progress Table
                $('#uploadProgressTable tbody').remove();

                var fileList = $('#id_dataset_files')[0].files;
                for (var i= 0, f=null; f=fileList[i]; i++) {
                    var newDatasetRow =
                            '<tr>' +
                            '<td>' + f.name + '</td>' +
                            '<td>' + formatFileSize(f.size) + '</td>' +
                            '<td></td>' +
                            '<td></td>' +
                            '<td></td>' +
                            '<td></td>' +
                            '</tr>';

                    $('#uploadProgressTable').append(newDatasetRow);
                }
            });

            $("#bulkSubmit").submit(function(event){
                //disable the submit button until after the files have been uploaded and the datasets have been created.
                $("#bulkSubmit").attr("disabled", true);

                // Indicate to user that we are going to wait a long time
                $("#loading").show();
            });
        });
    </script>
{% endblock %}

{% block content %}

<a href="usr.html" rel="prev">Back to user's portal</a>

<h2>Add Bulk Datasets</h2>

<form id="datasetAddFormBulk" name="datasetAddFormBulk" action="" method="post" enctype="multipart/form-data">{% csrf_token %}
    <div style="width:100em">
        <fieldset class="multiFieldSet">
            <legend>Bulk Add Multiple Datasets From CSV</legend>
            <table>
                <tr><td><label>{{ addBulkDatasetForm.dataset_files.label }}</label></td>
                    <td>{{ addBulkDatasetForm.dataset_files }}</td>
                    <td class="errortext">{{ addBulkDatasetForm.dataset_files.errors }}</td>
                </tr>
                <tr><td><label>{{ addBulkDatasetForm.compound_datatype.label }}</label></td>
                    <td>{{ addBulkDatasetForm.compound_datatype }}</td>
                    <td class="errortext">{{ addBulkDatasetForm.compound_datatype.errors }}</td>
                </tr>
            </table>
        </fieldset>
        <input type="bulkSubmit" name="bulkSubmit" value="Submit Bulk Datasets" />

        <div class="bulk_dataset_table">
            <p><span>Uploaded Datasets</span></p>
            <table id="uploadProgressTable">
                <thead>
                    <tr>
                        <th>File Name</th>
                        <th>File Size</th>
                        <th>Dataset Name</th>
                        <th>Dataset Description</th>
                        <th>Dataset MD5</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for updateBulkDatasetForm in updateBulkDatasetForms %}
                        <tr>
                            <!-- instance means Django model.  Noneditable -->
                            <td>{{ updateBulkDatasetForm.instance.orig_filename }}</td>
                            <td>{{ updateBulkDatasetForm.instance.dataset_file.size }}</td>
                            <td>{{ updateBulkDatasetForm.instance.dataset.name }}</td>
                            <td>{{ updateBulkDatasetForm.dataset.description }}</td>
                            <td>{{ updateBulkDatasetForm.instance.dataset.compute_md5 }}</td>
                            <td>{{ updateBulkDatasetForm.instance.create_status }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="errorStrip errortext">{{ create_error }}</div>
        <div id="loading" class="loading_container">
            <p><img src="loading.gif" class="loading_img"/>Please Wait...</p>
        </div>
    </div>
</form>
{% endblock %}
