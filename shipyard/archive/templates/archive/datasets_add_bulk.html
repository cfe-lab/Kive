<!-- Django template -->
<!-- Display contents of Methods as a HTML table -->

{% extends "portal/base.html" %}

{% block title %}Datasets{% endblock %}
<style>
    .bar {
        height: 18px;
        background: green;
    }

    .bulk_dataset_table {
        overflow:scroll;
        height:50em;
        clear: both;
    }

    .loading_container {
        position:absolute;
        top:0;
        left:0;
        width:100%;
        height:100%;
        z-index:1000;
        background-color:grey;
        opacity: .8;
    }

    .loading_img {
        position: absolute;
        left: 50%;
        top: 50%;
        margin-left: -32px; /* -1 * image width / 2 */
        margin-top: -32px;  /* -1 * image height / 2 */
        display: block;
    }

</style>
{% block javascript %}
    <script src="/static/portal/jquery-2.0.3.min.js"></script>
    <script src="/static/portal/jquery-ui-1.10.4.custom.min.js"></script>
    <script>
        // Helper function that formats the file sizes
        function formatFileSize(bytes) {
            if (typeof bytes !== 'number') {
                return '';
            }
            else if (bytes >= 1099511627776) {
                return (bytes / 1099511627776).toFixed(2) + ' TB';
            }
            else if (bytes >= 1073741824) {
                return (bytes / 1073741824).toFixed(2) + ' GB';
            }
            else if (bytes >= 1048576) {
                return (bytes / 1048576).toFixed(2) + ' MB';
            }
            else if (bytes >= 1024) {
                return (bytes / 1024).toFixed(2) + ' KB';
            }
            return bytes + ' B';
        }

        $("document").ready(function(readEvent){

            if (window.File && window.FileReader && window.FileList && window.Blob) {
              // Great success! All the File APIs are supported.
            } else {
              alert('Unsupported browser');
            }

            // Hide loading gif
            $("#loading").hide();

            $("#id_dataset_files").change(function(changeEvt) {
                // clear contents of Upload Progress Table
                $('#uploadProgressTable tbody').remove();

                var fileList = $('#id_dataset_files')[0].files;
                for (var i= 0; i < fileList.length; i++) {
                    var f = fileList[i];
                    var newDatasetRow =
                        '<tr>' +
                        '<td>' + f.name + '</td>' +
                        '<td>' + formatFileSize(f.size) + '</td>' +
                        '<td></td>' +  // Dataset Name
                        '<td></td>' +  // Dataset Description
                        '<td></td>' +  // Dataset MD5
                        '<td></td>' +  // Dataset status
                        '</tr>';
                    $('#uploadProgressTable').append(newDatasetRow);
                }
            });

            $("#bulkSubmit").submit(function(submitEvent){
                //disable the submit button until after the files have been uploaded and the datasets have been created.
                $("#bulkSubmit").attr("disabled", true);

                // Indicate to user that we are going to wait a long time
                $("#loading").show();

                // Update mode?
                if (!$("#editButton").is(":disabled")) {
                    $("#datasetBulkForm").action = "/datasets_update_bulk";
                }
            });
        });
    </script>
{% endblock %}

{% block content %}

<a href="usr.html" rel="prev">Back to user's portal</a>

<h2>Add Bulk Datasets</h2>

<form id="datasetBulkForm" name="datasetBulkForm" action="" method="post" enctype="multipart/form-data">{% csrf_token %}
    <div style="width:100em">
        <fieldset class="multiFieldSet">
            <legend>Bulk Add Multiple Datasets</legend>
            <table>
                <tr><td><label>{{ bulkAddDatasetForm.dataset_files.label }}</label></td>
                    <td>{{ bulkAddDatasetForm.dataset_files }}</td>
                    <td class="errortext">{{ bulkAddDatasetForm.dataset_files.errors }}</td>

                    <td><label>{{ bulkAddDatasetForm.compound_datatype.label }}</label></td>
                    <td>{{ bulkAddDatasetForm.compound_datatype }}</td>
                    <td class="errortext">{{ bulkAddDatasetForm.compound_datatype.errors }}</td>
                </tr>
                <tr><td><label>{{ bulkAddDatasetForm.name_prefix.label }}</label></td>
                    <td>{{ bulkAddDatasetForm.name_prefix }}</td>
                    <td class="errortext">{{ bulkAddDatasetForm.name_prefix.errors }}</td>

                    <td><label>{{ bulkAddDatasetForm.description.label }}</label></td>
                    <td>{{ bulkAddDatasetForm.description }}</td>
                    <td class="errortext">{{ bulkAddDatasetForm.description.errors }}</td>
                </tr>
            </table>
        </fieldset>
        <input type="submit" id="bulkSubmit" name="bulkSubmit" value="Submit Bulk Datasets" />


        <div class="bulk_dataset_table">
            <table id="uploadProgressTable">
                <thead>
                    <tr>
                        <th>File Name</th>
                        <th>File Size</th>
                        <th>Dataset Name</th>
                        <th>Description</th>
                        <th>MD5</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for bulkDisplayResult in bulkDisplayResults %}
                        <tr>
                            <!-- instance means Django model.  Noneditable -->
                            <td>{{ bulkDisplayResult.orig_filename }}</td>
                            <td>{{ bulkDisplayResult.dataset.get_formatted_filesize }}</td>
                            <td>{{ bulkDisplayResult.dataset.name }}</td>
                            <td>{{ bulkDisplayResult.dataset.description }}</td>
                            <td>{{ bulkDisplayResult.dataset.compute_md5 }}</td>
                            <td>{{ bulkDisplayResult.status }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="errorStrip errortext">{{ create_error }}</div>
        <div id="loading" class="loading_container">
            <p><img src="loading.gif" class="loading_img"/>Please Wait...</p>
        </div>
    </div>
</form>
{% endblock %}
